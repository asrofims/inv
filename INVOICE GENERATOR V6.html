<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembuat Invoice PDF - AFSUNMEDIA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .header-logo {
            font-size: 2.5em;
            font-weight: 600;
            color: #000000;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .container {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            max-width: 800px; /* Batas lebar kontainer utama */
            margin: 0 auto;
        }

        h1, h2 {
            color: var(--text-color);
            margin-bottom: 20px;
        }
        h1 { font-size: 1.8em; font-weight: 600; }
        h2 { font-size: 1.5em; font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 30px; }

        label { display: block; margin-top: 15px; margin-bottom: 8px; font-weight: 500; font-size: 0.95em; }

        input[type="text"], input[type="number"], textarea {
            width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 1px solid var(--border-color);
            border-radius: 8px; box-sizing: border-box; font-size: 1em;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); outline: none;
        }
        textarea { min-height: 100px; resize: vertical; }

        button {
            background-color: var(--primary-color); color: white; padding: 12px 25px; border: none;
            border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 500;
            transition: background-color 0.2s ease-in-out; margin-top: 10px;
        }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: var(--secondary-color); }
        button.secondary:hover { background-color: #545b62; }
        button.danger { background-color: var(--danger-color); } /* Class "danger" sudah ada di HTML Anda */
        button.danger:hover { background-color: #c82333; }

        .btn-action-small {
            padding: 5px 10px;
            font-size: 0.8em;
            margin-top: 0;
            border-radius: 4px;
            margin-right: 5px;
        }
        .btn-action-small:last-child { margin-right: 0; }
        .btn-delete-single { background-color: var(--warning-color); color: #212529; } /* Sesuai HTML Anda */
        .btn-delete-single:hover { background-color: #e0a800; }
        .btn-reprint-single { background-color: var(--secondary-color); color: white; } /* Sesuai HTML Anda */
        .btn-reprint-single:hover { background-color: #545b62; }

        /* === PDF TEMPLATE STYLING (untuk invoice individual) === */
        #invoice-preview-container {
            position: absolute; left: -9999px; top: -9999px; width: 210mm;
            background: white; font-family: 'Poppins', sans-serif; color: #333;
        }
        #invoice-preview { padding: 0; box-sizing: border-box; width: 100%; }
        .pdf-section { margin-bottom: 8mm; padding: 0 10mm; }
        .pdf-section:first-child { margin-top: 5mm; }
        .pdf-section:last-child { margin-bottom: 0; }
        .pdf-header { text-align: center; margin-bottom: 8mm; }
        .pdf-logo-text { font-size: 26pt; font-weight: 600; color: #000000; display: block; margin-bottom: 4mm; }
        .pdf-invoice-title { font-size: 18pt; font-weight: 500; color: #333; margin: 0; border-bottom: 1.5px solid #eee; padding-bottom: 2mm; display: inline-block; }
        .pdf-meta-info { overflow: auto; margin-bottom: 7mm; font-size: 10pt; }
        .pdf-meta-left { float: left; width: 48%; }
        .pdf-meta-right { float: right; width: 48%; text-align: right; }
        .pdf-meta-info p { margin: 1.5mm 0; line-height: 1.4; }
        .pdf-client-details h3, .pdf-payment-info h3, .pdf-booking-details-container h3 {
            font-size: 12pt; font-weight: 600; color: #222;
            margin-top: 0; margin-bottom: 2.5mm;
            border-bottom: 1px solid #eaeaea; padding-bottom: 1.5mm;
        }
        .pdf-client-details p, .pdf-payment-info p { margin: 1.5mm 0; font-size: 10pt; line-height: 1.5; }
        .pdf-booking-content { padding: 1mm 0; white-space: pre-wrap; font-size: 10pt; line-height: 1.5; min-height: 20mm; }
        .pdf-total-amount { margin-top: 6mm; text-align: right; font-size: 13pt; font-weight: bold; padding: 3mm; background-color: #f0f0f0; border-radius: 3px; }
        .pdf-footer { margin-top: 8mm; text-align: center; font-size: 8.5pt; color: #777; border-top: 1px solid #eee; padding-top: 3mm; }

        /* === STYLING TABEL RIWAYAT (untuk tampilan layar) === */
        #invoice-history { margin-top: 40px; overflow-x: auto; }
        #invoice-history table {
            width: 100%; 
            border-collapse: collapse;
            margin-top: 15px;
            table-layout: fixed; 
        }
        #invoice-history th, #invoice-history td {
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            text-align: left;
            font-size: 0.85em;
            vertical-align: middle;
            overflow-wrap: break-word; 
        }

        #invoice-history th:nth-child(1) { width: 16%; } 
        #invoice-history th:nth-child(2) { width: 20%; } 
        #invoice-history th:nth-child(3) { width: 27%; } 
        #invoice-history th:nth-child(4) { width: 12%; text-align: right;} 
        #invoice-history th:nth-child(5) { width: 12%; } 
        #invoice-history th:nth-child(6),
        #invoice-history td:nth-child(6) { 
            width: 13%;
            text-align: center;
        }
        #invoice-history td:nth-child(4) { text-align: right; } 


        #invoice-history th { background-color: #e9ecef; font-weight: 600; }
        #invoice-history tr:nth-child(even) { background-color: #f8f9fa; }
        .total-payment { margin-top: 20px; font-size: 1.2em; font-weight: 600; text-align: right; }
        .history-actions {
            margin-top: 15px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        #invoice-history td .btn-action-small { display: inline-block; margin-bottom: 3px;}


        /* === CSS UNTUK CETAK RIWAYAT (MENGGANTIKAN BLOK @media print SEBELUMNYA) === */
        @media print {
            /* 0. Aturan @page untuk margin (opsional, browser support bervariasi untuk Save to PDF) */
            @page {
                margin: 15mm 10mm 15mm 10mm; /* Atas, Kanan, Bawah, Kiri */
            }

            /* 1. Sembunyikan semua elemen di body pada awalnya */
            body * {
                visibility: hidden;
                background-color: transparent !important; /* Hindari background aneh */
                box-shadow: none !important; /* Hilangkan shadow */
                color: #000 !important; /* Pastikan semua teks hitam */
            }

            /* 2. Tampilkan hanya section .print-area dan semua isinya */
            /* Sesuai HTML Anda, .print-area ada di div#historyTableContainer */
            #historyTableContainer.print-area,
            #historyTableContainer.print-area * {
                visibility: visible;
            }

            /* 3. Atur .print-area agar mengambil seluruh halaman cetak */
            #historyTableContainer.print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%; /* Mengambil lebar area cetak setelah margin @page */
                margin: 0;
                padding: 0; /* Padding utama dari @page margin */
                box-sizing: border-box;
                font-size: 9pt; /* Ukuran font dasar untuk cetak */
            }

            /* (Opsional) Jika Anda ingin menambahkan judul di dalam .print-area untuk cetak */
            /* Anda perlu menambahkan elemen ini di HTML di dalam div.print-area */
            /* Contoh: <h2 class="print-only-title">Riwayat Invoice Dibuat</h2> */
            #historyTableContainer.print-area .print-only-title { /* Sesuaikan dengan class yang Anda gunakan */
                display: block !important;
                visibility: visible !important;
                text-align: center;
                font-size: 14pt;
                font-weight: 600;
                margin-bottom: 8mm;
                padding-bottom: 2mm;
                border-bottom: 1px solid #ccc;
            }

            /* 4. Styling Tabel Riwayat untuk Cetak */
            #historyTableContainer.print-area #historyTable {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed; /* Penting untuk menjaga lebar kolom */
                margin-top: 0; /* Jika tidak ada judul di atasnya */
            }

            #historyTableContainer.print-area #historyTable th,
            #historyTableContainer.print-area #historyTable td {
                border: 1px solid #333; /* Border lebih tegas untuk print */
                padding: 2mm 1.5mm;    /* Padding sel (sesuaikan) */
                text-align: left;
                vertical-align: top; /* Mulai teks dari atas sel */
                overflow-wrap: break-word; /* Memecah kata panjang */
                /* word-break: break-all; */ /* Alternatif jika break-word tidak cukup */
            }

            #historyTableContainer.print-area #historyTable th {
                background-color: #e9ecef !important; /* Warna latar header tabel */
                font-weight: bold;
                -webkit-print-color-adjust: exact; /* Memaksa browser mencetak warna background */
                print-color-adjust: exact;
            }

            /* 5. Sembunyikan kolom "Aksi" (kolom ke-6) saat mencetak */
            #historyTableContainer.print-area #historyTable th:nth-child(6),
            #historyTableContainer.print-area #historyTable td:nth-child(6) {
                display: none !important;
            }

            /* 6. Sesuaikan lebar kolom untuk 5 kolom yang tersisa saat cetak */
            /* Distribusi ulang dari total 87% (tanpa kolom Aksi 13%) menjadi 100% */
            #historyTableContainer.print-area #historyTable th:nth-child(1) { width: 18%; } /* No. Invoice (dari 16%) */
            #historyTableContainer.print-area #historyTable th:nth-child(2) { width: 23%; } /* Nama Client (dari 20%) */
            #historyTableContainer.print-area #historyTable th:nth-child(3) { width: 31%; } /* Detail Booking (dari 27%) */
            #historyTableContainer.print-area #historyTable th:nth-child(4) { width: 14%; text-align: right;} /* Nominal (Rp) (dari 12%) */
            #historyTableContainer.print-area #historyTable th:nth-child(5) { width: 14%; } /* Tanggal Terbit (dari 12%) */

            /* Pastikan sel nominal juga rata kanan */
            #historyTableContainer.print-area #historyTable td:nth-child(4) {
                text-align: right;
            }
            
            /* 7. Styling untuk Total Pembayaran */
            #historyTableContainer.print-area .total-payment {
                margin-top: 5mm;
                text-align: right;
                font-weight: bold;
                font-size: 10pt;
                page-break-inside: avoid; /* Hindari total terpisah dari tabel jika mungkin */
            }

            /* 8. Mencegah elemen terpotong antar halaman */
            #historyTableContainer.print-area #historyTable tr {
                page-break-inside: avoid;
            }

            /* 9. Sembunyikan elemen lain yang tidak diinginkan dari halaman utama */
            /* Ini adalah lapisan tambahan untuk memastikan hanya .print-area yang muncul */
            .header-logo,
            .container > h1, /* "Buat Invoice PDF" */
            .container > label,
            .container > input,
            .container > textarea,
            .container > button, /* Tombol utama "Buat dan Unduh Invoice PDF" */
            #invoice-preview-container, /* Template PDF untuk invoice individual */
            #invoice-history > h2, /* Judul "Riwayat Invoice Dibuat" di layar */
            .history-actions /* Tombol "Cetak Riwayat" & "Hapus Semua" di layar */
            {
                display: none !important;
            }
        }
        /* === AKHIR BLOK CSS UNTUK CETAK RIWAYAT === */

    </style>
</head>
<body>

    <div class="header-logo">AFSUNMEDIA</div>

<div class="container">
    <h1>Buat Invoice PDF</h1>
    <label for="clientName">Nama Client:</label>
    <input type="text" id="clientName" name="clientName" required>
    <label for="bookingDetails">Detail Booking:</label>
    <textarea id="bookingDetails" name="bookingDetails" rows="4" required></textarea>
    <label for="amount">Nominal (Rp):</label>
    <input type="number" id="amount" name="amount" step="any" required>
    <button onclick="generateInvoice()">Buat dan Unduh Invoice PDF</button>

    <div id="invoice-preview-container">
        <div id="invoice-preview">
            <div class="pdf-section pdf-header">
                <span class="pdf-logo-text">AFSUNMEDIA</span>
                <span class="pdf-invoice-title">INVOICE</span>
            </div>
            <div class="pdf-section pdf-meta-info">
                <div class="pdf-meta-left">
                    <p><strong>Kepada:</strong> <span id="previewClientNamePdf"></span></p>
                </div>
                <div class="pdf-meta-right">
                    <p><strong>No. Invoice:</strong> <span id="previewInvoiceNumberPdf"></span></p>
                    <p><strong>Tanggal Terbit:</strong> <span id="previewIssueDatePdf"></span></p>
                </div>
            </div>
            <div class="pdf-section pdf-booking-details-container">
                <h3>Detail Booking</h3>
                <div id="previewBookingDetailsPdf" class="pdf-booking-content"></div>
            </div>
            <div class="pdf-section pdf-total-amount">
                <strong>Total Pembayaran:</strong> Rp <span id="previewAmountPdf"></span>
            </div>
            <div class="pdf-section pdf-payment-info">
                <h3>Informasi Pembayaran</h3>
                <p>Mohon lakukan pembayaran ke rekening berikut:</p>
                <p><strong>Bank:</strong> BCA</p>
                <p><strong>No. Rekening:</strong> 323 055 9553</p>
                <p><strong>Atas Nama:</strong> Mochammad Samsul Asrofi</p>
            </div>
            <div class="pdf-section pdf-footer">
                <p>Terima kasih atas kepercayaan Anda. Invoice ini diterbitkan secara otomatis.</p>
            </div>
        </div>
    </div>

    <div id="invoice-history"> <h2>Riwayat Invoice Dibuat</h2>
        <div class="history-actions">
            <button class="secondary" onclick="printHistory()">Cetak Riwayat</button>
            <button class="danger" onclick="confirmDeleteAllHistory()">Hapus Semua Riwayat</button>
        </div>
        <div id="historyTableContainer" class="print-area"> <table id="historyTable">
                <thead>
                    <tr>
                        <th>No. Invoice</th>
                        <th>Nama Client</th>
                        <th>Detail Booking</th>
                        <th>Nominal (Rp)</th>
                        <th>Tanggal Terbit</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="total-payment">Total Pembayaran: Rp <span id="totalHistoryAmount">0</span></div>
        </div>
    </div>
</div>


<script>
    const STORAGE_KEY = 'afsInvoiceHistoryData';
    let invoiceHistory = [];

    function formatDate(date) {
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}-${month}-${year}`;
    }

    function formatCurrency(value) {
        return parseFloat(value).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function generateUniqueInvoiceNumber() {
        const timestampPart = Date.now().toString().slice(-7);
        const randomPart = Math.floor(Math.random() * 90 + 10);
        return `INV-${timestampPart}-${randomPart}`;
    }

    function saveHistoryToStorage() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(invoiceHistory));
        } catch (e) {
            console.error("Gagal menyimpan riwayat ke localStorage:", e);
        }
    }

    function loadHistoryFromStorage() {
        const storedHistory = localStorage.getItem(STORAGE_KEY);
        if (storedHistory) {
            try {
                const parsedHistory = JSON.parse(storedHistory);
                if (Array.isArray(parsedHistory)) {
                    invoiceHistory = parsedHistory;
                } else {
                    localStorage.removeItem(STORAGE_KEY);
                }
            } catch (e) {
                console.error("Error parsing riwayat dari localStorage:", e);
                localStorage.removeItem(STORAGE_KEY);
            }
        }
    }

    function populatePreviewForPdf(invoiceNum, clientName, issueDateStr, bookingDetailsStr, amountNum) {
        console.log("Populating preview with:", {invoiceNum, clientName, issueDateStr, bookingDetailsStr, amountNum});
        try {
            document.getElementById('previewInvoiceNumberPdf').textContent = invoiceNum || '';
            document.getElementById('previewClientNamePdf').textContent = clientName || '';
            document.getElementById('previewIssueDatePdf').textContent = issueDateStr || '';
            document.getElementById('previewBookingDetailsPdf').textContent = bookingDetailsStr || '';
            document.getElementById('previewAmountPdf').textContent = amountNum ? formatCurrency(amountNum) : '0';
            console.log("Elemen preview PDF telah diisi.");
            return true;
        } catch (e) {
            console.error("Error saat mengisi elemen preview PDF:", e);
            alert("Terjadi kesalahan internal saat menyiapkan data invoice. Cek konsol.");
            return false;
        }
    }

    function generateInvoice() {
        const clientName = document.getElementById('clientName').value;
        const bookingDetails = document.getElementById('bookingDetails').value;
        const amountInput = document.getElementById('amount').value;

        if (!clientName || !bookingDetails || !amountInput) {
            alert("Harap isi semua kolom yang diperlukan!");
            return;
        }
        const amount = parseFloat(amountInput);
        if (isNaN(amount) || amount <= 0) {
            alert("Nominal tidak valid!");
            return;
        }

        const issueDate = new Date();
        const formattedIssueDate = formatDate(issueDate);
        const invoiceNumber = generateUniqueInvoiceNumber();

        if (!populatePreviewForPdf(invoiceNumber, clientName, formattedIssueDate, bookingDetails, amount)) {
            return;
        }

        const invoiceContentElement = document.getElementById('invoice-preview');
        const opt = {
            margin: 10, // Margin halaman PDF (dalam mm)
            filename: `Invoice-${invoiceNumber}-${clientName.replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: 2, // Resolusi gambar
                useCORS: true, // Jika ada gambar eksternal
                logging: true, // Untuk debugging html2canvas jika ada masalah
                scrollX: 0, // Memastikan mulai dari posisi scroll 0
                scrollY: 0 
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } // Mode page break
        };

        html2pdf().from(invoiceContentElement).set(opt).save()
            .then(() => {
                addToHistory(invoiceNumber, clientName, bookingDetails, amount, formattedIssueDate);
                // Kosongkan form setelah berhasil
                document.getElementById('clientName').value = '';
                document.getElementById('bookingDetails').value = '';
                document.getElementById('amount').value = '';
            })
            .catch(err => {
                console.error("Error selama pembuatan atau penyimpanan PDF:", err);
                alert("Terjadi kesalahan saat membuat atau menyimpan PDF. Silakan coba lagi.\nCek konsol browser (F12) untuk detail error.");
            });
    }


    function addToHistory(invoiceNumber, clientName, bookingDetails, amount, issueDate) {
        const newInvoice = { invoiceNumber, clientName, bookingDetails, amount, issueDate };
        invoiceHistory.push(newInvoice);
        saveHistoryToStorage();
        renderHistory();
    }

    function renderHistory() {
        const historyTableBody = document.getElementById('historyTable').getElementsByTagName('tbody')[0];
        historyTableBody.innerHTML = ''; // Kosongkan tabel sebelum render ulang
        let totalAmount = 0;

        if (invoiceHistory.length === 0) {
            const newRow = historyTableBody.insertRow();
            const cell = newRow.insertCell(0);
            cell.colSpan = 6; // Sesuaikan dengan jumlah kolom di tabel riwayat Anda
            cell.textContent = "Belum ada riwayat"; // Teks diubah sesuai permintaan
            cell.style.textAlign = "center";
            cell.style.padding = "20px"; // Beri padding agar terlihat lebih baik
            cell.style.fontStyle = "italic"; // Opsional: buat miring
        } else {
            invoiceHistory.forEach(invoice => {
                const newRow = historyTableBody.insertRow();
                newRow.insertCell(0).textContent = invoice.invoiceNumber;
                newRow.insertCell(1).textContent = invoice.clientName;
                newRow.insertCell(2).innerHTML = invoice.bookingDetails.replace(/\n/g, '<br>'); // Agar baris baru dari textarea tampil
                newRow.insertCell(3).textContent = formatCurrency(invoice.amount);
                newRow.insertCell(4).textContent = invoice.issueDate;

                const cellActions = newRow.insertCell(5);
                cellActions.style.textAlign = 'center'; // Pusatkan tombol di sel

                const reprintButton = document.createElement('button');
                reprintButton.textContent = 'Ulang';
                reprintButton.classList.add('btn-action-small', 'btn-reprint-single');
                reprintButton.onclick = function() { reprintInvoice(invoice); }; // Kirim objek invoice lengkap
                cellActions.appendChild(reprintButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Hapus';
                deleteButton.classList.add('btn-action-small', 'btn-delete-single');
                deleteButton.onclick = function() { confirmDeleteSingleInvoice(invoice.invoiceNumber); };
                cellActions.appendChild(deleteButton);

                totalAmount += invoice.amount;
            });
        }
        document.getElementById('totalHistoryAmount').textContent = formatCurrency(totalAmount);
    }

    function printHistory() { window.print(); }

    function confirmDeleteAllHistory() {
        if (confirm("Apakah Anda yakin ingin menghapus SEMUA riwayat invoice? Tindakan ini tidak dapat diurungkan.")) {
            deleteAllInvoiceHistory();
        }
    }

    function deleteAllInvoiceHistory() {
        invoiceHistory = [];
        localStorage.removeItem(STORAGE_KEY); // Hapus dari localStorage juga
        renderHistory(); // Perbarui tampilan
        alert("Semua riwayat invoice telah berhasil dihapus.");
    }

    function confirmDeleteSingleInvoice(invoiceNumber) {
        if (confirm(`Apakah Anda yakin ingin menghapus invoice nomor ${invoiceNumber}?`)) {
            deleteSingleInvoice(invoiceNumber);
        }
    }

    function deleteSingleInvoice(invoiceNumberToDelete) {
        invoiceHistory = invoiceHistory.filter(invoice => invoice.invoiceNumber !== invoiceNumberToDelete);
        saveHistoryToStorage(); // Simpan perubahan ke localStorage
        renderHistory(); // Perbarui tampilan
        alert(`Invoice nomor ${invoiceNumberToDelete} telah dihapus.`);
    }

    function reprintInvoice(invoiceData) { // Terima objek invoice lengkap
        console.log("Mencetak ulang invoice:", invoiceData);

        // Langsung gunakan data dari objek invoiceData
        if (!populatePreviewForPdf(
            invoiceData.invoiceNumber,
            invoiceData.clientName,
            invoiceData.issueDate, // Asumsikan issueDate sudah string DD-MM-YYYY
            invoiceData.bookingDetails,
            invoiceData.amount
        )) {
            return; // Jika populate gagal
        }

        const invoiceContentElement = document.getElementById('invoice-preview');
        const opt = {
            margin: 10, // Margin halaman PDF (dalam mm)
            filename: `Invoice-${invoiceData.invoiceNumber}-${invoiceData.clientName.replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_')}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: {
                scale: 2,
                useCORS: true,
                logging: true, 
                scrollX: 0, 
                scrollY: 0  
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        html2pdf().from(invoiceContentElement).set(opt).save()
            .then(() => {
                console.log("Cetak ulang PDF berhasil.");
            })
            .catch(err => {
                console.error("Error selama cetak ulang PDF:", err);
                alert("Terjadi kesalahan saat mencetak ulang PDF. Silakan coba lagi.\nCek konsol browser (F12) untuk detail error.");
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadHistoryFromStorage();
        renderHistory();
    });
</script>

</body>
</html>
